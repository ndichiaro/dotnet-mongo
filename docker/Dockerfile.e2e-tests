# Dockerfile for E2E tests
FROM mcr.microsoft.com/dotnet/sdk:9.0

WORKDIR /app

# Install MongoDB shell for database operations
RUN apt-get update && apt-get install -y wget gnupg && \
    wget -qO - https://www.mongodb.org/static/pgp/server-7.0.asc | apt-key add - && \
    echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | tee /etc/apt/sources.list.d/mongodb-org-7.0.list && \
    apt-get update && \
    apt-get install -y mongodb-mongosh && \
    rm -rf /var/lib/apt/lists/*

# Copy E2E solution and project files for caching
COPY ../tests/Tools.Net.Mongo.E2E.Test/Tools.Net.Mongo.E2E.sln ./tests/Tools.Net.Mongo.E2E.Test/
COPY ../src/Tools.Net.Mongo/Tools.Net.Mongo.csproj ./src/Tools.Net.Mongo/
COPY ../src/Tools.Net.Mongo.Core/Tools.Net.Mongo.Core.csproj ./src/Tools.Net.Mongo.Core/
COPY ../src/Tools.Net.Mongo.Migrate/Tools.Net.Mongo.Migrate.csproj ./src/Tools.Net.Mongo.Migrate/
COPY ../src/Tools.Net.Cli.Driver/Tools.Net.Cli.Driver.csproj ./src/Tools.Net.Cli.Driver/
COPY ../tests/Tools.Net.Mongo.E2E.Test/Tools.Net.Mongo.E2E.Test.csproj ./tests/Tools.Net.Mongo.E2E.Test/
COPY ../tests/Demo.App/Demo.App.csproj ./tests/Demo.App/

# Restore dependencies
RUN dotnet restore tests/Tools.Net.Mongo.E2E.Test/Tools.Net.Mongo.E2E.sln

# Copy source code
COPY ../src/ ./src/
COPY ../tests/Tools.Net.Mongo.E2E.Test/ ./tests/Tools.Net.Mongo.E2E.Test/
COPY ../tests/Demo.App/ ./tests/Demo.App/

# Build the solution (restore again to ensure all dependencies after copying source)
RUN dotnet restore tests/Tools.Net.Mongo.E2E.Test/Tools.Net.Mongo.E2E.sln
RUN dotnet build tests/Tools.Net.Mongo.E2E.Test/Tools.Net.Mongo.E2E.sln -c Release --no-restore

# Build and copy the migration tool to the test data directory
RUN dotnet publish src/Tools.Net.Mongo/Tools.Net.Mongo.csproj -c Release -f net9.0 -o /app/migration-tool --no-restore

# Copy TestData to build output and copy migration tool DLL to test data directory
RUN mkdir -p /app/tests/Tools.Net.Mongo.E2E.Test/bin/Release/net9.0/TestData && \
    cp -r /app/tests/Tools.Net.Mongo.E2E.Test/TestData/* /app/tests/Tools.Net.Mongo.E2E.Test/bin/Release/net9.0/TestData/ && \
    cp /app/migration-tool/Tools.Net.Mongo.dll /app/tests/Tools.Net.Mongo.E2E.Test/bin/Release/net9.0/TestData/SampleProject/ && \
    cp /app/migration-tool/Tools.Net.Mongo.deps.json /app/tests/Tools.Net.Mongo.E2E.Test/bin/Release/net9.0/TestData/SampleProject/ && \
    cp /app/migration-tool/Tools.Net.Mongo.runtimeconfig.json /app/tests/Tools.Net.Mongo.E2E.Test/bin/Release/net9.0/TestData/SampleProject/ && \
    cp -r /app/migration-tool/*.dll /app/tests/Tools.Net.Mongo.E2E.Test/bin/Release/net9.0/TestData/SampleProject/ 2>/dev/null || true

# Set the entrypoint to run tests
ENTRYPOINT ["dotnet", "test", "/app/tests/Tools.Net.Mongo.E2E.Test/Tools.Net.Mongo.E2E.Test.csproj", "--no-build", "-c", "Release", "--logger", "console;verbosity=detailed"]
